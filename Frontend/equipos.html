<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Equipos | InventarioEquiposTI</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="app-shell">

  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Equipos</h1>
        <small>InventarioEquiposTI • CRUD + PDF</small>
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn-fx" href="index.html">⟵ Atrás</a>
      <button class="btn-fx btn-accent" onclick="exportarPDF()">
        Exportar PDF
      </button>
    </div>
  </div>

  <div class="glass card-pad">
    <span class="badge-chip">Gestión de Equipos</span>
    <hr>

    <form id="frmEquipo" class="row g-2 mb-3">
      <input type="hidden" name="id" id="id">

      <div class="col-md-2">
        <label class="form-label">Código</label>
        <input class="form-control" name="codigo" required placeholder="EQ-001">
      </div>
      <div class="col-md-3">
        <label class="form-label">Nombre</label>
        <input class="form-control" name="nombre" required placeholder="PC Administrativo">
      </div>
      <div class="col-md-2">
        <label class="form-label">Marca</label>
        <input class="form-control" name="marca" placeholder="HP">
      </div>
      <div class="col-md-2">
        <label class="form-label">Modelo</label>
        <input class="form-control" name="modelo" placeholder="ProDesk">
      </div>
      <div class="col-md-3">
        <label class="form-label">Serie</label>
        <input class="form-control" name="serie" placeholder="SER-0001">
      </div>

      <div class="col-md-4">
        <label class="form-label">Departamento</label>
        <select class="form-select" name="id_departamento" id="dep"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Estado</label>
        <select class="form-select" name="estado">
          <option>Activo</option>
          <option>Dado de baja</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Fecha compra</label>
        <input type="date" class="form-control" name="fecha_compra" id="fecha_compra">
      </div>

      <div class="col-md-2 d-grid align-items-end">
        <button class="btn-fx btn-accent mt-4">Guardar</button>
      </div>
    </form>

    <!-- FILTRO FECHAS -->
    <div class="row g-2 mb-3">
      <div class="col-md-3">
        <label class="form-label">Desde</label>
        <input type="date" id="fDesde" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Hasta</label>
        <input type="date" id="fHasta" class="form-control">
      </div>
      <div class="col-md-6 d-flex align-items-end gap-2">
        <button type="button" class="btn-fx" onclick="filtrar()">Filtrar</button>
        <button type="button" class="btn-fx" onclick="limpiarFiltro()">Limpiar</button>
        <button type="button" class="btn-fx btn-accent" onclick="exportarPDF(true)">Exportar PDF (Filtro)</button>
      </div>
    </div>

    <table class="table table-striped table-sm" id="tbl">
      <thead>
        <tr><th>Código</th><th>Nombre</th><th>Depto.</th><th>Estado</th><th>Fecha compra</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

<script src="app.js"></script>
<script>
const form = document.getElementById("frmEquipo");
const tbody = document.querySelector("#tbl tbody");
const depSelect = document.getElementById("dep");

async function cargarDeps() {
  const deps = await apiGet({controller:"equipo", action:"deps"});
  depSelect.innerHTML = deps.map(d => `<option value="${d.id}">${d.nombre}</option>`).join("");
}

async function cargarEquipos() {
  const datos = await apiGet({controller:"equipo", action:"index"});
  tbody.innerHTML = datos.map(e => `
    <tr>
      <td>${e.codigo}</td>
      <td>${e.nombre}</td>
      <td>${e.departamento ?? ""}</td>
      <td>${e.estado ?? "Activo"}</td>
      <td>${e.fecha_compra ?? ""}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick='editar(${JSON.stringify(e)})'>Editar</button>
        <button class="btn btn-sm btn-danger" onclick="eliminar(${e.id})">Eliminar</button>
      </td>
    </tr>
  `).join("");
}

function editar(e) {
  form.id.value = e.id;
  form.codigo.value = e.codigo;
  form.nombre.value = e.nombre;
  form.marca.value = e.marca ?? "";
  form.modelo.value = e.modelo ?? "";
  form.serie.value = e.serie ?? "";
  document.getElementById("fecha_compra").value = e.fecha_compra ?? "";
  depSelect.value = e.id_departamento;
  form.estado.value = e.estado ?? "Activo";
}

async function eliminar(id) {
  if (!confirm("¿Eliminar equipo?")) return;
  const fd = new FormData();
  fd.append("id", id);
  await fetch(API + "?controller=equipo&action=delete", {method:"POST", body:fd});
  cargarEquipos();
}

form.addEventListener("submit", async e => {
  e.preventDefault();
  await apiPost({controller:"equipo", action:"save"}, "#frmEquipo");
  form.reset();
  document.getElementById("id").value = "";
  cargarEquipos();
});

function filtrar(){
  // fecha_compra está en la columna 5 (index 4)
  filterTableByDate({ tableSelector:"#tbl", dateColIndex: 4, fromId:"fDesde", toId:"fHasta" });
}

function limpiarFiltro(){
  document.getElementById("fDesde").value = "";
  document.getElementById("fHasta").value = "";
  document.querySelectorAll("#tbl tbody tr").forEach(tr => tr.style.display = "");
}

function exportarPDF(usandoFiltro = false){
  const desde = document.getElementById("fDesde").value || "N/A";
  const hasta = document.getElementById("fHasta").value || "N/A";
  exportTableToPDF({
    title: "Reporte de Equipos",
    subtitle: usandoFiltro ? `Periodo: ${desde} hasta ${hasta}` : "Listado general de equipos",
    tableSelector: "#tbl",
    fileName: usandoFiltro ? "equipos_filtrado.pdf" : "equipos.pdf",
    orientation: "l",
    responsable: "Ing. Jhoe Cadena",
    cargo: "Responsable de Sistemas",
    empresa: "InventarioEquiposTI",
    logoPath: "logo.png"
  });
}

cargarDeps();
cargarEquipos();
</script>
</body>
</html>
