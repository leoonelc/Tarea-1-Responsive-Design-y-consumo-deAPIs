<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Departamentos | InventarioEquiposTI</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="app-shell">

  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Departamentos</h1>
        <small>InventarioEquiposTI • CRUD + PDF</small>
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn-fx" href="index.html">⟵ Atrás</a>
      <button class="btn-fx btn-accent" onclick="exportarPDF()">
        Exportar PDF
      </button>
    </div>
  </div>

  <div class="glass card-pad">
    <span class="badge-chip">Gestión de Departamentos</span>
    <hr>

    <form id="frmDep" class="row g-2 mb-3">
      <input type="hidden" name="id" id="id">
      <div class="col-md-8">
        <label class="form-label">Nombre</label>
        <input class="form-control" name="nombre" placeholder="Ej: Sistemas, Producción" required>
      </div>
      <div class="col-md-4 d-grid align-items-end">
        <button class="btn-fx btn-accent mt-4">Guardar</button>
      </div>
    </form>

    <table class="table table-striped table-sm" id="tbl">
      <thead>
        <tr><th>Nombre</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

<script src="app.js"></script>
<script>
const form = document.getElementById("frmDep");
const tbody = document.querySelector("#tbl tbody");

async function cargar() {
  const datos = await apiGet({controller:"departamento", action:"index"});
  tbody.innerHTML = datos.map(d => `
    <tr>
      <td>${d.nombre}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick='editar(${JSON.stringify(d)})'>Editar</button>
        <button class="btn btn-sm btn-danger" onclick="eliminar(${d.id})">Eliminar</button>
      </td>
    </tr>
  `).join("");
}

function editar(dep) {
  form.id.value = dep.id;
  form.nombre.value = dep.nombre;
}

async function eliminar(id) {
  if (!confirm("¿Eliminar departamento?")) return;
  const fd = new FormData();
  fd.append("id", id);
  await fetch(API + "?controller=departamento&action=delete", { method:"POST", body: fd });
  cargar();
}

form.addEventListener("submit", async e => {
  e.preventDefault();
  await apiPost({controller:"departamento", action:"save"}, "#frmDep");
  form.reset(); form.id.value = "";
  cargar();
});

function exportarPDF(){
  exportTableToPDF({
    title: "Reporte de Departamentos",
    subtitle: "Estructura organizacional",
    tableSelector: "#tbl",
    fileName: "departamentos.pdf",
    orientation: "p",
    responsable: "Ing. Jhoe Cadena",
    cargo: "Responsable de Sistemas",
    empresa: "InventarioEquiposTI",
    logoPath: "logo.png"
  });
}

cargar();
</script>
</body>
</html>
